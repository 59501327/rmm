@Library('jenkins_shared_lib') _

pipeline {
  agent any
  environment {
    // Serves to represent in what 'mode' this run is happening.
    // Will be used to determine whether packages should be uploaded (branch&nightly) or not (PRs)
    // Value will be dynamically computed by a utility tool to be included in gpuci-tools
    BUILD_MODE = 'pull-request'
  }
  options {
    buildDiscarder(logRotator(numToKeepStr: '10'))
    ansiColor('xterm')
  }
  stages {
    stage("Style Checks") {
      steps {
        sh "env"
      }
    }
    stage("C++ Matrix Build") {
      environment {
        PARALLEL_LEVEL = '4'
      }
      options {
        timeout(time: 30, unit: 'MINUTES') 
      }
      steps {
        script {
          // generate the CUDA stages across different configuration options
          parallel generateStage("cuda_build", {
            withCredentials([[
                $class: 'AmazonWebServicesCredentialsBinding',
                credentialsId: "aws-s3-gpuci",
                accessKeyVariable: 'AWS_ACCESS_KEY_ID',
                secretKeyVariable: 'AWS_SECRET_ACCESS_KEY'
            ]]) {
              sh "./ci/build_cpp.sh"
            }
          })
        }
      }
    }

    stage("Python Matrix Build") {
      options {
        timeout(time: 30, unit: 'MINUTES') 
      }
      steps {
        script {
          // generate the python stages across different configuration options
          parallel generateStage("python_build", {
            withCredentials([[
                $class: 'AmazonWebServicesCredentialsBinding',
                credentialsId: "aws-s3-gpuci",
                accessKeyVariable: 'AWS_ACCESS_KEY_ID',
                secretKeyVariable: 'AWS_SECRET_ACCESS_KEY'
            ]]) {
              sh "./ci/build_py.sh"
            }
          })
        }
      }
    }

    stage("PR/Branch Test Stage") {
      when { not { triggeredBy 'TimerTrigger' } }
      options {
        timeout(time: 10, unit: 'MINUTES') 
      }
      steps {
        script {
          // generate the PR/Branch test stages across different configuration options
          parallel generateStage("branch_pr_test",{
            withCredentials([[
                $class: 'AmazonWebServicesCredentialsBinding',
                credentialsId: "aws-s3-gpuci",
                accessKeyVariable: 'AWS_ACCESS_KEY_ID',
                secretKeyVariable: 'AWS_SECRET_ACCESS_KEY'
            ]]) {
              sh "./ci/gpu_test.sh"
            }
          })
        }
      }
    }

    stage("Nightly Test Stage") {
      when { triggeredBy 'TimerTrigger' }
      options {
        timeout(time: 10, unit: 'MINUTES') 
      }
      environment { UPLOAD_PKGS = "true" }
      steps {
        script {
          // generate the nightly test stages across different configuration options
          parallel generateStage("branch_pr_test",{
            withCredentials([[
                $class: 'AmazonWebServicesCredentialsBinding',
                credentialsId: "aws-s3-gpuci",
                accessKeyVariable: 'AWS_ACCESS_KEY_ID',
                secretKeyVariable: 'AWS_SECRET_ACCESS_KEY'
            ]]) {
              sh "./ci/gpu_test.sh"
            }
          })
        }
      }
    }
  }
}
