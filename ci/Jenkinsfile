@Library('gpuci_shared_lib') _

pipeline {
  agent any
  options {
    buildDiscarder(logRotator(numToKeepStr: '1')) 
    ansiColor('xterm')
  }
  stages {
    stage("Build Stage") { 
      steps {
        sh "env"
        echo "${currentBuild.buildCauses}"
      }
    }
    stage("C++ Matrix Build") {
      environment {
        buildCudaVarName = '1'
        BUILD_TYPE = 'cpu'
        BUILD_MODE = 'pull-request'
        REPO = "rmm"
        PARALLEL_LEVEL = '4'
        CUDA="11.5"
      }
      steps {
        sh "echo starting C++ matrix builds"
        sh 'printenv'

        script {
          parallel generateStage("cuda_build", {
            checkout scm

            withCredentials([[
                $class: 'AmazonWebServicesCredentialsBinding',
                credentialsId: "aws-s3-gpuci",
                accessKeyVariable: 'AWS_ACCESS_KEY_ID',
                secretKeyVariable: 'AWS_SECRET_ACCESS_KEY'
            ]]) {
              sh '''#!/bin/bash
                set -e
                TMPDIR=${WORKSPACE}/tmp

                unset SUDO_UID SUDO_GID SUDO_USER
                BUILD_SCRIPT="ci/build_cpp.sh"

                export NVCC="/usr/local/cuda/bin/nvcc"
                export CUDAToolkit_ROOT="/usr/local/cuda"
                export CUDACXX="/usr/local/cuda/bin/nvcc"

                cd "$WORKSPACE"

                #Override nvidia-smi to exit on 0 and 14 as succesful
                #14 is infoROM corrupted
                function nvidia-smi() {
                    /usr/bin/nvidia-smi $@
                    EXIT_VAL=$?
                    if [[ $EXIT_VAL == 0 || $EXIT_VAL == 14 ]]; then
                        return 0
                    fi
                    exit $EXIT_VAL
                }

                cd "$WORKSPACE"
                if [ -f $BUILD_SCRIPT ]; then
                    echo ">>>> Detected in repo script, using '${BUILD_SCRIPT}' for build..."
                    source ${BUILD_SCRIPT}
                else
                    echo ">>>> ERROR: No script '${BUILD_SCRIPT}' detected..."
                    exit 1
                fi
              '''                
            }

            echo "Hello CUDA!"
          })
        }
      }
    }

    stage("Python Matrix Build") {
      environment {
        CUDA="11.5"
      }
      steps {
        script {
          parallel generateStage("python_build", {
            cleanWs (
              deleteDirs: true,
              externalDelete: 'sudo rm -rf %s'
            )
            checkout scm

            withCredentials([[
                $class: 'AmazonWebServicesCredentialsBinding',
                credentialsId: "aws-s3-gpuci",
                accessKeyVariable: 'AWS_ACCESS_KEY_ID',
                secretKeyVariable: 'AWS_SECRET_ACCESS_KEY'
            ]]) {
              sh '''#!/bin/bash
                set -e
                TMPDIR=${WORKSPACE}/tmp

                unset SUDO_UID SUDO_GID SUDO_USER
                BUILD_SCRIPT="ci/build_py.sh"

                export NVCC="/usr/local/cuda/bin/nvcc"
                export CUDAToolkit_ROOT="/usr/local/cuda"
                export CUDACXX="/usr/local/cuda/bin/nvcc"

                cd "$WORKSPACE"
                if [ -f $BUILD_SCRIPT ]; then
                    echo ">>>> Detected in repo script, using '${BUILD_SCRIPT}' for build..."
                    source ${BUILD_SCRIPT}
                else
                    echo ">>>> ERROR: No script '${BUILD_SCRIPT}' detected..."
                    exit 1
                fi
              '''                
            }
            echo "Hello Python!"
          })
        }
      }
    }

    stage("PR/Branch Test Stage") {
      when { not { triggeredBy 'TimerTrigger' } }
      environment {
        CUDA="11.5"
        UPLOAD_PKGS = """${sh(
              returnStdout: true,
              script: 'echo "$GIT_BRANCH" | grep -iq "pr" && echo "false" || echo "true"'
          )}"""
      }
      steps {
        sh "env"
        echo "${currentBuild.buildCauses}"
        script {
          parallel generateStage("branch_pr_test",{
            cleanWs (
              deleteDirs: true,
              externalDelete: 'sudo rm -rf %s'
            )
            checkout scm
            withCredentials([[
                $class: 'AmazonWebServicesCredentialsBinding',
                credentialsId: "aws-s3-gpuci",
                accessKeyVariable: 'AWS_ACCESS_KEY_ID',
                secretKeyVariable: 'AWS_SECRET_ACCESS_KEY'
            ]]) {    
              echo "hello from rmm repo"
              echo "Upload packages: \${UPLOAD_PKGS}"
              sh '''#!/bin/bash
                source ci/gpu_test.sh
              '''         
            }
          })
        }
      }
    }

    stage("Nightly Test Stage") {
      when { triggeredBy 'TimerTrigger' }
      environment { UPLOAD_PKGS = "true" }
      steps {
        sh "env"
        echo "${currentBuild.buildCauses}"
        script {
          parallel generateStage("nightly_test", {
            cleanWs (
              deleteDirs: true,
              externalDelete: 'sudo rm -rf %s'
            )
            checkout scm
            echo "Upload packages: \${UPLOAD_PKGS}"
            echo "Uploading packages..."
          })
        }
      }
    }
  }
}